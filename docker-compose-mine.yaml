version: '3'

services:
  api:
    image: langgenius/dify-api:${DIFY_API_VERSION:-main}
    restart: always
    environment:
      MODE: api
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FILE: ${LOG_FILE:-}
      DEBUG: ${DEBUG:-false}
      FLASK_DEBUG: ${FLASK_DEBUG:-false}
      SECRET_KEY: ${SECRET_KEY:-sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U}
      INIT_PASSWORD: ${INIT_PASSWORD:-}
      CONSOLE_WEB_URL: ${CONSOLE_WEB_URL:-}
      CONSOLE_API_URL: ${CONSOLE_API_URL:-}
      SERVICE_API_URL: ${SERVICE_API_URL:-}
      APP_WEB_URL: ${APP_WEB_URL:-}
      CHECK_UPDATE_URL: ${CHECK_UPDATE_URL:-https://updates.dify.ai}
      OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
      FILES_URL: ${FILES_URL:-}
      FILES_ACCESS_TIMEOUT: ${FILES_ACCESS_TIMEOUT:-300}
      APP_MAX_ACTIVE_REQUESTS: ${APP_MAX_ACTIVE_REQUESTS:-0}
      MIGRATION_ENABLED: ${MIGRATION_ENABLED:-true}
      DEPLOY_ENV: ${DEPLOY_ENV:-PRODUCTION}
      DIFY_BIND_ADDRESS: ${DIFY_BIND_ADDRESS:-0.0.0.0}
      DIFY_PORT: ${DIFY_PORT:-5001}
      SERVER_WORKER_AMOUNT: ${SERVER_WORKER_AMOUNT:-}
      SERVER_WORKER_CLASS: ${SERVER_WORKER_CLASS:-}
      CELERY_WORKER_CLASS: ${CELERY_WORKER_CLASS:-}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-360}
      CELERY_WORKER_AMOUNT: ${CELERY_WORKER_AMOUNT:-}
      CELERY_AUTO_SCALE: ${CELERY_AUTO_SCALE:-false}
      CELERY_MAX_WORKERS: ${CELERY_MAX_WORKERS:-}
      CELERY_MIN_WORKERS: ${CELERY_MIN_WORKERS:-}
      API_TOOL_DEFAULT_CONNECT_TIMEOUT: ${API_TOOL_DEFAULT_CONNECT_TIMEOUT:-10}
      API_TOOL_DEFAULT_READ_TIMEOUT: ${API_TOOL_DEFAULT_READ_TIMEOUT:-60}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-difyai123456}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-dify}
      SQLALCHEMY_POOL_SIZE: ${SQLALCHEMY_POOL_SIZE:-30}
      SQLALCHEMY_POOL_RECYCLE: ${SQLALCHEMY_POOL_RECYCLE:-3600}
      SQLALCHEMY_ECHO: ${SQLALCHEMY_ECHO:-false}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_USERNAME: ${REDIS_USERNAME:-}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-difyai123456}
      REDIS_USE_SSL: ${REDIS_USE_SSL:-false}
      REDIS_DB: 0
      REDIS_USE_SENTINEL: ${REDIS_USE_SENTINEL:-false}
      REDIS_SENTINELS: ${REDIS_SENTINELS:-}
      REDIS_SENTINEL_SERVICE_NAME: ${REDIS_SENTINEL_SERVICE_NAME:-}
      REDIS_SENTINEL_USERNAME: ${REDIS_SENTINEL_USERNAME:-}
      REDIS_SENTINEL_PASSWORD: ${REDIS_SENTINEL_PASSWORD:-}
      REDIS_SENTINEL_SOCKET_TIMEOUT: ${REDIS_SENTINEL_SOCKET_TIMEOUT:-0.1}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://:difyai123456@redis:6379/1}
      BROKER_USE_SSL: ${BROKER_USE_SSL:-false}
      CELERY_USE_SENTINEL: ${CELERY_USE_SENTINEL:-false}
      CELERY_SENTINEL_MASTER_NAME: ${CELERY_SENTINEL_MASTER_NAME:-}
      CELERY_SENTINEL_SOCKET_TIMEOUT: ${CELERY_SENTINEL_SOCKET_TIMEOUT:-0.1}
      WEB_API_CORS_ALLOW_ORIGINS: ${WEB_API_CORS_ALLOW_ORIGINS:-*}
      CONSOLE_CORS_ALLOW_ORIGINS: ${CONSOLE_CORS_ALLOW_ORIGINS:-*}
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_LOCAL_PATH: storage
      VECTOR_STORE: ${VECTOR_STORE:-weaviate}
      WEAVIATE_ENDPOINT: ${WEAVIATE_ENDPOINT:-http://weaviate:8080}
      WEAVIATE_API_KEY: ${WEAVIATE_API_KEY:-WVF5YThaHlkYwhGUSmCRgsX3tD5ngdN8pkih}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-difyai123456}
      UPLOAD_FILE_SIZE_LIMIT: ${UPLOAD_FILE_SIZE_LIMIT:-15}
      UPLOAD_FILE_BATCH_LIMIT: ${UPLOAD_FILE_BATCH_LIMIT:-5}
      ETL_TYPE: ${ETL_TYPE:-dify}
      UNSTRUCTURED_API_URL: ${UNSTRUCTURED_API_URL:-}
      MULTIMODAL_SEND_IMAGE_FORMAT: ${MULTIMODAL_SEND_IMAGE_FORMAT:-base64}
      UPLOAD_IMAGE_FILE_SIZE_LIMIT: ${UPLOAD_IMAGE_FILE_SIZE_LIMIT:-10}
      SENTRY_DSN: ${API_SENTRY_DSN:-}
      SENTRY_TRACES_SAMPLE_RATE: ${API_SENTRY_TRACES_SAMPLE_RATE:-1.0}
      SENTRY_PROFILES_SAMPLE_RATE: ${API_SENTRY_PROFILES_SAMPLE_RATE:-1.0}
      MAIL_TYPE: ${MAIL_TYPE:-resend}
      MAIL_DEFAULT_SEND_FROM: ${MAIL_DEFAULT_SEND_FROM:-}
      SMTP_SERVER: ${SMTP_SERVER:-}
      SMTP_PORT: ${SMTP_PORT:-465}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_USE_TLS: ${SMTP_USE_TLS:-true}
      SMTP_OPPORTUNISTIC_TLS: ${SMTP_OPPORTUNISTIC_TLS:-false}
      RESEND_API_KEY: ${RESEND_API_KEY:-your-resend-api-key}
      RESEND_API_URL: https://api.resend.com
      INVITE_EXPIRY_HOURS: ${INVITE_EXPIRY_HOURS:-72}
      RESET_PASSWORD_TOKEN_EXPIRY_HOURS: ${RESET_PASSWORD_TOKEN_EXPIRY_HOURS:-24}
      CODE_EXECUTION_ENDPOINT: ${CODE_EXECUTION_ENDPOINT:-http://sandbox:8194}
      CODE_EXECUTION_API_KEY: ${SANDBOX_API_KEY:-dify-sandbox}
      SSRF_PROXY_HTTP_URL: ${SSRF_PROXY_HTTP_URL:-http://ssrf_proxy:3128}
      SSRF_PROXY_HTTPS_URL: ${SSRF_PROXY_HTTPS_URL:-http://ssrf_proxy:3128}
    volumes:
      - dify_api_storage:/app/api/storage

  worker:
    image: langgenius/dify-api:${DIFY_API_VERSION:-main}
    restart: always
    environment:
      MODE: worker
      LOG_LEVEL: ${LOG_LEVEL:-INFO}
      LOG_FILE: ${LOG_FILE:-}
      DEBUG: ${DEBUG:-false}
      FLASK_DEBUG: ${FLASK_DEBUG:-false}
      SECRET_KEY: ${SECRET_KEY:-sk-9f73s3ljTXVcMT3Blb3ljTqtsKiGHXVcMT3BlbkFJLK7U}
      INIT_PASSWORD: ${INIT_PASSWORD:-}
      CONSOLE_WEB_URL: ${CONSOLE_WEB_URL:-}
      CONSOLE_API_URL: ${CONSOLE_API_URL:-}
      SERVICE_API_URL: ${SERVICE_API_URL:-}
      APP_WEB_URL: ${APP_WEB_URL:-}
      CHECK_UPDATE_URL: ${CHECK_UPDATE_URL:-https://updates.dify.ai}
      OPENAI_API_BASE: ${OPENAI_API_BASE:-https://api.openai.com/v1}
      FILES_URL: ${FILES_URL:-}
      FILES_ACCESS_TIMEOUT: ${FILES_ACCESS_TIMEOUT:-300}
      APP_MAX_ACTIVE_REQUESTS: ${APP_MAX_ACTIVE_REQUESTS:-0}
      MIGRATION_ENABLED: ${MIGRATION_ENABLED:-true}
      DEPLOY_ENV: ${DEPLOY_ENV:-PRODUCTION}
      DIFY_BIND_ADDRESS: ${DIFY_BIND_ADDRESS:-0.0.0.0}
      DIFY_PORT: ${DIFY_PORT:-5001}
      SERVER_WORKER_AMOUNT: ${SERVER_WORKER_AMOUNT:-}
      SERVER_WORKER_CLASS: ${SERVER_WORKER_CLASS:-}
      CELERY_WORKER_CLASS: ${CELERY_WORKER_CLASS:-}
      GUNICORN_TIMEOUT: ${GUNICORN_TIMEOUT:-360}
      CELERY_WORKER_AMOUNT: ${CELERY_WORKER_AMOUNT:-}
      CELERY_AUTO_SCALE: ${CELERY_AUTO_SCALE:-false}
      CELERY_MAX_WORKERS: ${CELERY_MAX_WORKERS:-}
      CELERY_MIN_WORKERS: ${CELERY_MIN_WORKERS:-}
      API_TOOL_DEFAULT_CONNECT_TIMEOUT: ${API_TOOL_DEFAULT_CONNECT_TIMEOUT:-10}
      API_TOOL_DEFAULT_READ_TIMEOUT: ${API_TOOL_DEFAULT_READ_TIMEOUT:-60}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-difyai123456}
      DB_HOST: ${DB_HOST:-db}
      DB_PORT: ${DB_PORT:-5432}
      DB_DATABASE: ${DB_DATABASE:-dify}
      SQLALCHEMY_POOL_SIZE: ${SQLALCHEMY_POOL_SIZE:-30}
      SQLALCHEMY_POOL_RECYCLE: ${SQLALCHEMY_POOL_RECYCLE:-3600}
      SQLALCHEMY_ECHO: ${SQLALCHEMY_ECHO:-false}
      REDIS_HOST: ${REDIS_HOST:-redis}
      REDIS_PORT: ${REDIS_PORT:-6379}
      REDIS_USERNAME: ${REDIS_USERNAME:-}
      REDIS_PASSWORD: ${REDIS_PASSWORD:-difyai123456}
      REDIS_USE_SSL: ${REDIS_USE_SSL:-false}
      REDIS_DB: 0
      REDIS_USE_SENTINEL: ${REDIS_USE_SENTINEL:-false}
      REDIS_SENTINELS: ${REDIS_SENTINELS:-}
      REDIS_SENTINEL_SERVICE_NAME: ${REDIS_SENTINEL_SERVICE_NAME:-}
      REDIS_SENTINEL_USERNAME: ${REDIS_SENTINEL_USERNAME:-}
      REDIS_SENTINEL_PASSWORD: ${REDIS_SENTINEL_PASSWORD:-}
      REDIS_SENTINEL_SOCKET_TIMEOUT: ${REDIS_SENTINEL_SOCKET_TIMEOUT:-0.1}
      CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://:difyai123456@redis:6379/1}
      BROKER_USE_SSL: ${BROKER_USE_SSL:-false}
      CELERY_USE_SENTINEL: ${CELERY_USE_SENTINEL:-false}
      CELERY_SENTINEL_MASTER_NAME: ${CELERY_SENTINEL_MASTER_NAME:-}
      CELERY_SENTINEL_SOCKET_TIMEOUT: ${CELERY_SENTINEL_SOCKET_TIMEOUT:-0.1}
      WEB_API_CORS_ALLOW_ORIGINS: ${WEB_API_CORS_ALLOW_ORIGINS:-*}
      CONSOLE_CORS_ALLOW_ORIGINS: ${CONSOLE_CORS_ALLOW_ORIGINS:-*}
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_LOCAL_PATH: storage
      VECTOR_STORE: ${VECTOR_STORE:-weaviate}
      WEAVIATE_ENDPOINT: ${WEAVIATE_ENDPOINT:-http://weaviate:8080}
      WEAVIATE_API_KEY: ${WEAVIATE_API_KEY:-WVF5YThaHlkYwhGUSmCRgsX3tD5ngdN8pkih}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
      QDRANT_API_KEY: ${QDRANT_API_KEY:-difyai123456}
      UPLOAD_FILE_SIZE_LIMIT: ${UPLOAD_FILE_SIZE_LIMIT:-15}
      UPLOAD_FILE_BATCH_LIMIT: ${UPLOAD_FILE_BATCH_LIMIT:-5}
      ETL_TYPE: ${ETL_TYPE:-dify}
      UNSTRUCTURED_API_URL: ${UNSTRUCTURED_API_URL:-}
      MULTIMODAL_SEND_IMAGE_FORMAT: ${MULTIMODAL_SEND_IMAGE_FORMAT:-base64}
      UPLOAD_IMAGE_FILE_SIZE_LIMIT: ${UPLOAD_IMAGE_FILE_SIZE_LIMIT:-10}
      SENTRY_DSN: ${API_SENTRY_DSN:-}
      SENTRY_TRACES_SAMPLE_RATE: ${API_SENTRY_TRACES_SAMPLE_RATE:-1.0}
      SENTRY_PROFILES_SAMPLE_RATE: ${API_SENTRY_PROFILES_SAMPLE_RATE:-1.0}
      MAIL_TYPE: ${MAIL_TYPE:-resend}
      MAIL_DEFAULT_SEND_FROM: ${MAIL_DEFAULT_SEND_FROM:-}
      SMTP_SERVER: ${SMTP_SERVER:-}
      SMTP_PORT: ${SMTP_PORT:-465}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_USE_TLS: ${SMTP_USE_TLS:-true}
      SMTP_OPPORTUNISTIC_TLS: ${SMTP_OPPORTUNISTIC_TLS:-false}
      RESEND_API_KEY: ${RESEND_API_KEY:-your-resend-api-key}
      RESEND_API_URL: https://api.resend.com
      INVITE_EXPIRY_HOURS: ${INVITE_EXPIRY_HOURS:-72}
      RESET_PASSWORD_TOKEN_EXPIRY_HOURS: ${RESET_PASSWORD_TOKEN_EXPIRY_HOURS:-24}
      CODE_EXECUTION_ENDPOINT: ${CODE_EXECUTION_ENDPOINT:-http://sandbox:8194}
      CODE_EXECUTION_API_KEY: ${SANDBOX_API_KEY:-dify-sandbox}
      SSRF_PROXY_HTTP_URL: ${SSRF_PROXY_HTTP_URL:-http://ssrf_proxy:3128}
      SSRF_PROXY_HTTPS_URL: ${SSRF_PROXY_HTTPS_URL:-http://ssrf_proxy:3128}

  web:
    image: langgenius/dify-web:${DIFY_WEB_VERSION:-main}
    restart: always
    environment:
      CONSOLE_API_URL: ${CONSOLE_API_URL:-}
      APP_API_URL: ${APP_API_URL:-}
      SENTRY_DSN: ${WEB_SENTRY_DSN:-}
      NEXT_TELEMETRY_DISABLED: ${NEXT_TELEMETRY_DISABLED:-1}

  db:
    image: postgres:${POSTGRES_VERSION:-15-alpine}
    restart: always
    environment:
      PGUSER: ${PGUSER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-difyai123456}
      POSTGRES_DB: ${POSTGRES_DB:-dify}
      PGDATA: ${PGDATA:-/var/lib/postgresql/data/pgdata}
    command: >
      postgres -c 'max_connections=${POSTGRES_MAX_CONNECTIONS:-100}'
               -c 'shared_buffers=${POSTGRES_SHARED_BUFFERS:-128MB}'
               -c 'work_mem=${POSTGRES_WORK_MEM:-4MB}'
               -c 'maintenance_work_mem=${POSTGRES_MAINTENANCE_WORK_MEM:-64MB}'
               -c 'effective_cache_size=${POSTGRES_EFFECTIVE_CACHE_SIZE:-4096MB}'
    volumes:
      - dify_db_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready"]
      interval: 1s
      timeout: 3s
      retries: 30

  redis:
    image: redis:${REDIS_VERSION:-6-alpine}
    restart: always
    volumes:
      - dify_redis_data:/data
    command: redis-server --requirepass ${REDIS_PASSWORD:-difyai123456}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]

  sandbox:
    image: langgenius/dify-sandbox:${DIFY_SANDBOX_VERSION:-main}
    restart: always
    environment:
      API_KEY: ${SANDBOX_API_KEY:-dify-sandbox}
      GIN_MODE: ${SANDBOX_GIN_MODE:-release}
      WORKER_TIMEOUT: ${SANDBOX_WORKER_TIMEOUT:-15}
      ENABLE_NETWORK: ${SANDBOX_ENABLE_NETWORK:-true}
      HTTP_PROXY: ${SANDBOX_HTTP_PROXY:-http://ssrf_proxy:3128}
      HTTPS_PROXY: ${SANDBOX_HTTPS_PROXY:-http://ssrf_proxy:3128}
      SANDBOX_PORT: ${SANDBOX_PORT:-8194}
    volumes:
      - dify_sandbox_dependencies:/dependencies
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8194/health"]

  ssrf_proxy:
    image: ubuntu/squid:${SQUID_VERSION:-latest}
    restart: always
    environment:
      HTTP_PORT: ${SSRF_HTTP_PORT:-3128}
      COREDUMP_DIR: ${SSRF_COREDUMP_DIR:-/var/spool/squid}
      REVERSE_PROXY_PORT: ${SSRF_REVERSE_PROXY_PORT:-8194}
      SANDBOX_HOST: ${SSRF_SANDBOX_HOST:-sandbox}
      SANDBOX_PORT: ${SANDBOX_PORT:-8194}       

  weaviate:
    image: semitechnologies/weaviate:${WEAVIATE_VERSION:-latest}
    restart: always
    volumes:
      - dify_weaviate_data:/var/lib/weaviate
    environment:
      QUERY_DEFAULTS_LIMIT: ${WEAVIATE_QUERY_DEFAULTS_LIMIT:-25}
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: ${WEAVIATE_AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED:-false}
      DEFAULT_VECTORIZER_MODULE: ${WEAVIATE_DEFAULT_VECTORIZER_MODULE:-none}
      CLUSTER_HOSTNAME: ${WEAVIATE_CLUSTER_HOSTNAME:-node1}
      AUTHENTICATION_APIKEY_ENABLED: ${WEAVIATE_AUTHENTICATION_APIKEY_ENABLED:-true}
      AUTHENTICATION_APIKEY_ALLOWED_KEYS: ${WEAVIATE_AUTHENTICATION_APIKEY_ALLOWED_KEYS:-WVF5YThaHlkYwhGUSmCRgsX3tD5ngdN8pkih}
      AUTHENTICATION_APIKEY_USERS: ${WEAVIATE_AUTHENTICATION_APIKEY_USERS:-hello@dify.ai}
      AUTHORIZATION_ADMINLIST_ENABLED: ${WEAVIATE_AUTHORIZATION_ADMINLIST_ENABLED:-true}
      AUTHORIZATION_ADMINLIST_USERS: ${WEAVIATE_AUTHORIZATION_ADMINLIST_USERS:-hello@dify.ai}

  pgvector:
    image: pgvector/pgvector:${PGVECTOR_VERSION:-pg16}
    restart: always
    environment:
      PGUSER: ${PGVECTOR_PGUSER:-postgres}
      POSTGRES_PASSWORD: ${PGVECTOR_POSTGRES_PASSWORD:-difyai123456}
      POSTGRES_DB: ${PGVECTOR_POSTGRES_DB:-dify}
      PGDATA: ${PGVECTOR_PGDATA:-/var/lib/postgresql/data/pgdata}
    volumes:
      - dify_pgvector_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD", "pg_isready"]
      interval: 1s
      timeout: 3s
      retries: 30

  chroma:
    image: ghcr.io/chroma-core/chroma:${CHROMA_VERSION:-0.5.1}
    restart: always
    volumes:
      - dify_chroma_data:/chroma/chroma
    environment:
      CHROMA_SERVER_AUTHN_CREDENTIALS: ${CHROMA_SERVER_AUTHN_CREDENTIALS:-difyai123456}
      CHROMA_SERVER_AUTHN_PROVIDER: ${CHROMA_SERVER_AUTHN_PROVIDER:-chromadb.auth.token_authn.TokenAuthenticationServerProvider}
      IS_PERSISTENT: ${CHROMA_IS_PERSISTENT:-TRUE}

volumes:
  dify_api_storage:
  dify_db_data:
  dify_redis_data:
  dify_sandbox_dependencies:
  dify_weaviate_data:
  dify_pgvector_data:
  dify_chroma_data:
